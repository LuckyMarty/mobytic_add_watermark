(function(t,e,a,i){"use strict";function r(e,a){this.element=e,this.settings=t.extend({},h,a),this._defaults=h,this._name=n,this.init()}var n="watermark",h={path:"watermark.png",dataPath:!1,text:"",textWidth:130,textSize:13,textColor:"white",textBg:"rgba(0, 0, 0, 0.4)",gravity:"se",opacity:.7,margin:0,fullOverlay:!1,outputWidth:"auto",outputHeight:"auto",outputType:"jpeg",done:function(t){this.src=t},fail:function(){},always:function(){}};t.extend(r.prototype,{init:function(){var e=this,a=e.element,i=e.settings,r=i.dataPath?t(a).data(i.dataPath):i.path,n={imgurl:r,type:"png",cross:!0},h={imgurl:a.src,cross:!0,type:i.outputType,width:i.outputWidth,height:i.outputHeight};0===r.search(/data:image\/(png|jpg|jpeg|gif);base64,/)&&(n.cross=!1),0===a.src.search(/data:image\/(png|jpg|jpeg|gif);base64,/)&&(h.cross=!1);var s=t.Deferred();t.when(s).done(function(t){h.wmObj=t,e.imgurltodata(h,function(t){i.done.call(a,t),i.always.call(a,t)})}),""!==i.text&&(n.imgurl=e.textwatermark(),n.cross=!1),e.imgurltodata(n,function(t){s.resolve(t)})},textwatermark:function(){var t=this,e=t.settings,i=a.createElement("CANVAS"),r=i.getContext("2d"),n=e.textWidth,h=e.textSize+8;return i.width=n,i.height=h,r.fillStyle=e.textBg,r.fillRect(0,0,n,h),r.fillStyle=e.textColor,r.textAlign="center",r.font="500 "+e.textSize+"px Sans-serif",r.fillText(e.text,n/2,e.textSize+2),i.toDataURL()},imgurltodata:function(t,e){var i=this,r=i.settings,n=i.element,h=new Image;t.cross&&(h.crossOrigin="Anonymous"),h.onload=function(){var i,n=a.createElement("CANVAS"),h=n.getContext("2d"),s=this.width,o=this.height;if(t.wmObj&&("auto"!==t.width&&"auto"===t.height&&t.width<s?(o=o/s*t.width,s=t.width):"auto"===t.width&&"auto"!==t.height&&t.height<o?(s=s/o*t.height,o=t.height):"auto"!==t.width&&"auto"!==t.height&&t.width<s&&t.height<o&&(s=t.width,o=t.height)),"w"!==r.gravity&&"e"!==r.gravity||t.wmObj?(n.width=s,n.height=o,i=0):(n.width=o,n.height=s,i=-o,h.rotate(90*Math.PI/180)),"jpeg"===t.type&&(h.fillStyle="#ffffff",h.fillRect(0,0,s,o)),h.drawImage(this,0,i,s,o),t.wmObj){var l=r.opacity;l>0&&l<1&&(h.globalAlpha=r.opacity);var g,u,c=r.fullOverlay?s:t.wmObj.width,f=r.fullOverlay?o:t.wmObj.height,d=r.margin;switch(r.gravity){case"nw":g=d,u=d;break;case"n":g=s/2-c/2,u=d;break;case"ne":g=s-c-d,u=d;break;case"w":g=d,u=o/2-f/2;break;case"e":g=s-c-d,u=o/2-f/2;break;case"sw":g=d,u=o-f-d;break;case"s":g=s/2-c/2,u=o-f-d;break;case"c":g=s/2-c/2,u=(o-f)/2;break;default:g=s-c-d,u=o-f-d}h.drawImage(t.wmObj,g,u,c,f)}var w=n.toDataURL("image/"+t.type);if("function"==typeof e)if(t.wmObj)e(w);else{var m=new Image;m.src=w,e(m)}n=null},h.onerror=function(){return r.fail.call(this,this.src),r.always.call(n,this.src),!1},h.src=t.imgurl}}),t.fn[n]=function(e){return this.each(function(){t.data(this,"plugin_"+n)||t.data(this,"plugin_"+n,new r(this,e))})}})(jQuery,window,document);